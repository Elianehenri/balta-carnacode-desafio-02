@page "/"

@using System.ComponentModel.DataAnnotations
@inject NavigationManager navigation
@inject Microsoft.JSInterop.IJSRuntime JSRuntime
@inject ILocalStorageService localStorage 

<link rel="stylesheet" href="Calculation.razor.css" />

<PageTitle>Calculation</PageTitle>

<h1 class="title">Cálculo de IMC</h1>

<div class="form-container">
    <EditForm Model="@model" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="input-container">
            <InputText id="input-altura" class="input-text input-spacing" @bind-Value="@model.Altura" placeholder="Altura" />
            <ValidationMessage For="@(() => model.Altura)" />

            <InputText id="input-peso" class="input-text input-spacing" @bind-Value="@model.Peso" placeholder="Peso" />
            <ValidationMessage For="@(() => model.Peso)" />

            <InputText id="input-sexo" class="input-text input-spacing" @bind-Value="@model.Sexo" placeholder="Sexo" />
            <ValidationMessage For="@(() => model.Sexo)" />
        </div>

        <div class="checkbox-container">
            <div class="mais65anos">
                <InputCheckbox id="input-mais65anos" class="checkbox" @bind-Value="@model.Mais65Anos" />
                <label for="input-mais65anos">Eu tenho 65 anos ou mais</label>
            </div>
        </div>

        <div class="btn-container">
            <button type="submit" class="btn1">
                <span>Calcular meu IMC</span>
            </button>
            <button type="button" class="btn2" @onclick="HandleEntendaClick">
                <span>Entenda o cálculo</span>
            </button>
        </div>
    </EditForm>
</div>

@code {
    private BMIModel model = new BMIModel
        {
            Altura = null,
            Peso = null,
            Sexo = null
        };
    private List<BMIModel> savedData = new List<BMIModel>(); // Declaração e inicialização da lista

    private async Task HandleSubmit()
    {
        // Verificar se os campos obrigatórios estão preenchidos antes de prosseguir
        if (string.IsNullOrWhiteSpace(model.Altura) || string.IsNullOrWhiteSpace(model.Peso) || string.IsNullOrWhiteSpace(model.Sexo))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Por favor, preencha todos os campos obrigatórios.");
            return;
        }

        // Adicionar o novo conjunto de dados ao List e salvar no LocalStorage
        savedData.Add(model);
        await localStorage.SetItemAsync("savedData", savedData);

        // Limpar os campos do formulário
        model.Altura = null;
        model.Peso = null;
        model.Sexo = null;
        model.Mais65Anos = false;

        // Mostrar alerta com o IMC calculado
        await ShowIMCAlert();
    }

    private async Task ShowIMCAlert()
    {
        if (!string.IsNullOrWhiteSpace(model.Altura) && !string.IsNullOrWhiteSpace(model.Peso))
        {
            if (double.TryParse(model.Altura, out double altura) && double.TryParse(model.Peso, out double peso))
            {
                double alturaMetros = altura / 100;
                double imc = peso / (alturaMetros * alturaMetros);

                // Verifica o IMC e define a situação
                string situacao = GetBmiSituation(imc);

                // Exibe o resultado do IMC
                await JSRuntime.InvokeVoidAsync("alert", $"Seu IMC é: {imc:F2}. Situação: {situacao}");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Por favor, insira valores válidos para altura e peso.");
            }
        }
    }

    private string GetBmiSituation(double bmi)
    {
        if (bmi < 17.0)
        {
            return "Muito abaixo do peso";
        }
        else if (bmi >= 17.0 && bmi < 18.5)
        {
            return "Abaixo do peso";
        }
        else if (bmi >= 18.5 && bmi < 25)
        {
            return "Peso normal";
        }
        else if (bmi >= 25 && bmi < 30)
        {
            return "Acima do peso";
        }
        else if (bmi >= 30 && bmi < 35)
        {
            return "Obesidade I";
        }
        else if (bmi >= 35 && bmi < 40)
        {
            return "Obesidade II (severa)";
        }
        else
        {
            return "Obesidade III (mórbida)";
        }
    }

    private async Task HandleEntendaClick()
    {
        string mensagem = "O Índice de Massa Corporal (IMC) é uma medida utilizada para avaliar se uma pessoa está no peso ideal, com base na sua altura. " +
                          "Ele é calculado dividindo o peso (em quilogramas) pela altura ao quadrado (em metros). " +
                          "O resultado indica se a pessoa está abaixo do peso, com peso normal, acima do peso ou obesa.";

        // Exibir a mensagem em um alerta usando JavaScript
        await JSRuntime.InvokeVoidAsync("alert", mensagem);
    }
}
